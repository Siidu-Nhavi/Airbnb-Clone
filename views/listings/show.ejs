<% layout("/layouts/boilerplate") %>

<div class="container mt-5">

  <h3 class="text-center mb-4 fw-bold">
    <%= listing.title %>
  </h3>

  <div class="card mx-auto shadow-sm listing-card" style="max-width: 30rem;">
    <img src="<%= listing.image.url %>" class="card-img-top" alt="<%= listing.title %>">

    <div class="card-body">

      <p class="card-text">
        Owned by <i><%= listing.owner.username %></i>
      </p>

      <p class="card-text text-secondary">
        <%= listing.description %>
      </p>

      <p class="card-text fw-bold mb-1">
        Price: &#8377;
        <%= listing.price ? listing.price.toLocaleString('en-IN') : "N/A" %>
      </p>

      <p class="card-text text-muted mb-3">
        Location: <%= listing.location %>, <%= listing.country %>
      </p>

      <% if (currUser && listing.owner._id.equals(currUser._id)) { %>
        <div class="d-flex justify-content-between">
          <a href="/listings/<%= listing._id %>/edit"
             class="btn btn-warning w-50 me-2">
            Edit
          </a>

          <form method="POST"
                action="/listings/<%= listing._id %>?_method=DELETE"
                class="w-50">
            <button class="btn btn-danger w-100">
              Delete
            </button>
          </form>
        </div>
      <% } %>

      <div class="text-center mt-3">
        <a href="/listings" class="btn btn-secondary btn-sm">
          ← Back to Listings
        </a>
      </div>

    </div>

    <!-- Review Section -->
    <% if (currUser) { %>
      <div class="p-3">
        <h4>Leave a Review</h4>
        <hr>

        <form action="/listings/<%= listing._id %>/reviews"
              method="POST"
              class="needs-validation"
              novalidate>

          <div class="mb-3">
            <label for="rating" class="form-label">Rating</label>
            <input type="range"
                   min="1"
                   max="5"
                   id="rating"
                   name="review[rating]"
                   class="form-range"
                   required>
            <div class="invalid-feedback">
              Please select a rating between 1 and 5.
            </div>
          </div>

          <div class="mb-3">
            <label for="comment" class="form-label">Comments</label>
            <textarea name="review[comment]"
                      id="comment"
                      rows="5"
                      class="form-control"
                      required></textarea>
            <div class="invalid-feedback">
              Please write a comment before submitting.
            </div>
          </div>

          <button class="btn btn-outline-dark" type="submit">
            Submit
          </button>
        </form>
      </div>
      <hr />
    <% } %>

    <!-- All Reviews -->
    <p class="px-3"><b>All Reviews</b></p>
    <div class="row px-3">

      <% for (let review of listing.reviews) { %>
        <div class="card col-5 ms-3 mb-3">
          <div class="card-body">

            <h5 class="card-title">@
              <%= review.author.username %>
            </h5>

            <p class="card-text">
              <%= review.comment %>
            </p>

            <p class="card-text">
              <%= review.rating %> ⭐
            </p>

            <% if (currUser &&
                   review.author &&
                   review.author._id.equals(currUser._id)) { %>
              <form method="POST"
                    action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                <button class="btn btn-sm btn-dark">
                  Delete
                </button>
              </form>
            <% } %>

          </div>
        </div>
      <% } %>

    </div>

  </div>
</div>
